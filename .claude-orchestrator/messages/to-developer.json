{
  "messages": [{
    "type": "task_assignment",
    "taskId": "task-069",
    "platform": "web",
    "title": "Create voice-guided feedback system for video playback",
    "timestamp": "2025-12-18T07:27:44.490Z",
    "instructions": "## Voice-Guided Feedback System for Video Playback\n\n### Overview\nExtend the existing audio feedback infrastructure to provide synchronized voice narration during video playback analysis. Users will hear corrections while watching their exercise form without needing to read text.\n\n### Architecture\n- **Pattern**: Controller-Hook-Component composition\n- **Core Classes**: VideoPlaybackAudioController (exists), VideoFeedbackQueue (exists)\n- **Hook**: useVideoVoiceFeedback (exists - needs extension)\n- **UI Components**: VoiceFeedbackControlPanel + subcomponents (exist - may need updates)\n\n---\n\n## STEP 1: Extend VideoFeedbackQueue for skipCurrentFeedback\n\n**File**: `src/utils/videoFeedbackQueue.ts`\n\n1. Add a method to get the currently processing item:\n```typescript\nprivate currentItemId: string | null = null;\n\npublic setCurrentItem(id: string | null): void {\n  this.currentItemId = id;\n}\n\npublic getCurrentItem(): VideoAudioQueueItem | null {\n  return this.queue.find(item => item.id === this.currentItemId) ?? null;\n}\n\npublic skipCurrent(): VideoAudioQueueItem | null {\n  if (this.currentItemId) {\n    this.markAsProcessed(this.currentItemId);\n    this.currentItemId = null;\n  }\n  // Return next unprocessed item\n  return this.queue.find(item => !this.processedIds.has(item.id)) ?? null;\n}\n```\n\n---\n\n## STEP 2: Extend VideoPlaybackAudioController\n\n**File**: `src/utils/videoPlaybackAudioController.ts`\n\n1. Add skipCurrentFeedback method:\n```typescript\n/**\n * Skip currently speaking feedback and advance to next\n */\nskipCurrentFeedback(): void {\n  // Cancel current speech\n  if (isSpeechSupported() && window.speechSynthesis.speaking) {\n    window.speechSynthesis.cancel();\n  }\n  \n  this.isProcessingSpeech = false;\n  this.currentSpeechItem = null;\n  this.feedbackQueue.skipCurrent();\n  this.notifyStateChange();\n}\n```\n\n2. Update calculateSpeechRate to use video playback rate more precisely:\n```typescript\nprivate calculateSpeechRate(videoPlaybackRate: number): number {\n  if (!this.config.syncVoiceToPlaybackRate) return 1.1;\n  \n  // Scale speech rate proportionally with video speed\n  // but clamp to safe range for intelligibility\n  const scaledRate = 1.0 + (videoPlaybackRate - 1.0) * 0.5;\n  return Math.max(\n    this.config.minSpeechRate,\n    Math.min(this.config.maxSpeechRate, scaledRate)\n  );\n}\n```\n\n3. Add lookahead window config usage (currently uses announcementLeadTime, ensure it's honored):\n- The existing getItemsForTimestamp uses lookahead - verify it uses `this.config.announcementLeadTime` (default 500ms)\n\n---\n\n## STEP 3: Update useVideoVoiceFeedback Hook\n\n**File**: `src/hooks/useVideoVoiceFeedback.ts`\n\n1. Add skipCurrentFeedback to returned controls:\n```typescript\nconst skipCurrentFeedback = useCallback(() => {\n  if (controllerRef.current) {\n    controllerRef.current.skipCurrentFeedback();\n  }\n}, []);\n```\n\n2. Add to return object:\n```typescript\nreturn {\n  // ... existing\n  skipCurrentFeedback,\n};\n```\n\n3. Update interface UseVideoVoiceFeedbackReturn:\n```typescript\ninterface UseVideoVoiceFeedbackReturn {\n  // ... existing\n  skipCurrentFeedback: () => void;\n}\n```\n\n---\n\n## STEP 4: Update VoiceFeedbackControlPanel Component\n\n**File**: `src/components/VoiceFeedback/VoiceFeedbackControlPanel.tsx`\n\nThe component already has most functionality. Verify:\n\n1. Props include `onSkipCurrentFeedback`\n2. CurrentlySpeakingIndicator receives `onSkip` prop\n3. Design tokens are applied correctly\n\n---\n\n## STEP 5: Enhance CurrentlySpeakingIndicator\n\n**File**: `src/components/VoiceFeedback/CurrentlySpeakingIndicator.tsx`\n\nEnsure the skip button is visible and functional:\n```typescript\n// Design tokens\nconst COLORS = {\n  voiceActive: '#00F5A0',\n  voiceSpeaking: '#00ddff',\n  textPrimary: '#FFFFFF',\n  textSecondary: '#94A3B8',\n  surface: 'rgba(30, 41, 59, 0.95)',\n  borderDefault: 'rgba(75, 85, 99, 0.3)',\n};\n\n// Skip button styling\n<button\n  onClick={onSkip}\n  style={{\n    padding: '4px 8px',\n    backgroundColor: 'transparent',\n    border: `1px solid ${COLORS.borderDefault}`,\n    borderRadius: '4px',\n    color: COLORS.textSecondary,\n    fontSize: '12px',\n    cursor: 'pointer',\n  }}\n>\n  Skip\n</button>\n```\n\n---\n\n## STEP 6: Enhance TimelineMarkerOverlay\n\n**File**: `src/components/VoiceFeedback/TimelineMarkerOverlay.tsx`\n\nDisplay feedback markers on video timeline with priority colors:\n```typescript\nconst PRIORITY_COLORS = {\n  critical: '#FF3D71',      // priority-critical\n  high: '#FFB800',          // priority-high\n  medium: '#38BDF8',        // priority-medium\n  low: '#94A3B8',           // priority-low\n};\n\nconst REP_BOUNDARY_COLOR = '#7C3AED';  // rep-boundary\n\n// Marker positioning\nconst markerPosition = (timestamp / videoDuration) * 100;\n```\n\nComponent should:\n- Accept feedback items array and video duration\n- Render colored dots on timeline at correct positions\n- Show rep boundary markers with different style (purple)\n- Apply glow effect for critical markers: `boxShadow: '0 0 8px rgba(255, 61, 113, 0.4)'`\n\n---\n\n## STEP 7: Enhance AutoPauseNotification\n\n**File**: `src/components/VoiceFeedback/AutoPauseNotification.tsx`\n\nOverlay notification when video auto-pauses on critical issue:\n```typescript\nconst COLORS = {\n  autoPauseOverlay: 'rgba(255, 61, 113, 0.15)',\n  priorityCritical: '#FF3D71',\n  textPrimary: '#FFFFFF',\n  surface: 'rgba(30, 41, 59, 0.95)',\n  voiceActive: '#00F5A0',\n};\n\n// Component structure\n<div style={{\n  position: 'absolute',\n  inset: 0,\n  backgroundColor: COLORS.autoPauseOverlay,\n  display: 'flex',\n  alignItems: 'center',\n  justifyContent: 'center',\n}}>\n  <div style={{\n    backgroundColor: COLORS.surface,\n    padding: '24px',\n    borderRadius: '12px',\n    border: `2px solid ${COLORS.priorityCritical}`,\n    maxWidth: '400px',\n    textAlign: 'center',\n  }}>\n    <h3>Critical Issue Detected</h3>\n    <p>{issueDescription}</p>\n    <button onClick={onResume}>Resume Playback</button>\n  </div>\n</div>\n```\n\n---\n\n## STEP 8: Update UpcomingFeedbackPreview\n\n**File**: `src/components/VoiceFeedback/UpcomingFeedbackPreview.tsx`\n\nShow next 3-5 feedback items:\n```typescript\nconst FEEDBACK_COLORS = {\n  good: '#00F5A0',      // feedback-good\n  warning: '#FFB800',   // feedback-warning\n  error: '#FF3D71',     // feedback-error\n  info: '#38BDF8',      // feedback-info\n};\n\n// Format timestamp as MM:SS\nconst formatTime = (ms: number) => {\n  const seconds = Math.floor(ms / 1000);\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n};\n```\n\n---\n\n## STEP 9: Verify Type Definitions\n\n**File**: `src/types/videoVoiceFeedback.ts`\n\nEnsure these types exist and are complete:\n\n```typescript\nexport interface VideoVoiceFeedbackConfig extends AudioFeedbackConfig {\n  autoPauseOnCritical: boolean;\n  syncVoiceToPlaybackRate: boolean;\n  minSpeechRate: number;  // 0.7\n  maxSpeechRate: number;  // 1.5\n  lookaheadWindowMs: number;  // 500\n  enableRepSummaries: boolean;\n  seekDebounceMs: number;  // 150\n}\n\nexport interface UseVideoVoiceFeedbackReturn {\n  state: VideoVoiceFeedbackState;\n  config: VideoVoiceFeedbackConfig;\n  controls: {\n    initialize: () => Promise<boolean>;\n    loadAnalysis: (analysis: VideoRepAnalysisResult) => void;\n    syncToVideo: (videoElement: HTMLVideoElement) => void;\n    detachFromVideo: () => void;\n    play: () => void;\n    pause: () => void;\n    seekTo: (timeMs: number) => void;\n    setPlaybackRate: (rate: number) => void;\n    skipCurrentFeedback: () => void;\n    resumeFromAutoPause: () => void;\n  };\n  updateConfig: (config: Partial<VideoVoiceFeedbackConfig>) => void;\n  upcomingPreview: VideoFeedbackQueueItem[];\n}\n\nexport const VIDEO_VOICE_CONFIG_KEY = 'video-voice-feedback-config';\n```\n\n---\n\n## STEP 10: Integration Testing Points\n\n1. **Video Synchronization**:\n   - Verify timeupdate handler fires ~4 times/second\n   - Test lookahead window (500ms default) triggers speech before marker\n\n2. **Seek Handling**:\n   - Seek forward: items behind are marked processed\n   - Seek backward: items ahead have processed status cleared\n   - Debounce rapid seeking (150ms default)\n\n3. **Playback Rate Sync**:\n   - 0.5x video -> speech rate ~0.75x (clamped at 0.7)\n   - 1.0x video -> speech rate 1.0x\n   - 2.0x video -> speech rate 1.5x (clamped at 1.5)\n\n4. **Auto-Pause**:\n   - Critical issue pauses video\n   - AutoPauseNotification displays\n   - Resume button plays video\n   - isAutoPaused state tracks correctly\n\n5. **Rep Summaries**:\n   - Spoken at rep.endTimestamp\n   - Format: 'Rep {n} complete, score {x}, {issue/good form}'\n   - Toggle enableRepSummaries works\n\n6. **Config Persistence**:\n   - Saves to localStorage key 'video-voice-feedback-config'\n   - Loads on hook initialization\n   - ConfigPersistenceIndicator flashes on save\n\n7. **Language Support**:\n   - Korean (ko): Uses messages from REP_MESSAGES.ko\n   - English (en): Uses messages from REP_MESSAGES.en\n   - Template interpolation: {repNumber}, {score}, {issue}\n\n---\n\n## Design Token Reference\n\n```typescript\nconst DESIGN_TOKENS = {\n  colors: {\n    primary: '#00F5A0',\n    secondary: '#0284c7',\n    background: 'rgba(17, 24, 39, 0.85)',\n    surface: 'rgba(30, 41, 59, 0.95)',\n    textPrimary: '#FFFFFF',\n    textSecondary: '#94A3B8',\n    textMuted: '#64748B',\n    borderDefault: 'rgba(75, 85, 99, 0.3)',\n    voiceActive: '#00F5A0',\n    voiceSpeaking: '#00ddff',\n    priorityCritical: '#FF3D71',\n    priorityCriticalGlow: 'rgba(255, 61, 113, 0.4)',\n    priorityHigh: '#FFB800',\n    priorityMedium: '#38BDF8',\n    priorityLow: '#94A3B8',\n    repBoundary: '#7C3AED',\n    repBoundaryGlow: 'rgba(124, 58, 237, 0.3)',\n    timelineTrack: 'rgba(75, 85, 99, 0.5)',\n    timelineProgress: '#0284c7',\n    autoPauseOverlay: 'rgba(255, 61, 113, 0.15)',\n    feedbackGood: '#00F5A0',\n    feedbackWarning: '#FFB800',\n    feedbackError: '#FF3D71',\n    feedbackInfo: '#38BDF8',\n  },\n};\n```\n\n---\n\n## File Dependencies\n\n- `src/types/audioFeedback.ts` - Base audio types\n- `src/types/videoVoiceFeedback.ts` - Extended video voice types\n- `src/types/video.ts` - VideoRepAnalysisResult, RepAnalysisResult\n- `src/utils/audioFeedbackSystem.ts` - Base AudioFeedbackSystem class\n- `src/utils/videoPlaybackAudioController.ts` - Video-aware controller\n- `src/utils/videoFeedbackQueue.ts` - Timeline queue manager\n- `src/hooks/useVideoVoiceFeedback.ts` - React hook\n- `src/components/VoiceFeedback/*` - UI components",
    "filesToCreate": [],
    "filesToModify": [
      "src/utils/videoFeedbackQueue.ts",
      "src/utils/videoPlaybackAudioController.ts",
      "src/hooks/useVideoVoiceFeedback.ts",
      "src/types/videoVoiceFeedback.ts",
      "src/components/VoiceFeedback/CurrentlySpeakingIndicator.tsx",
      "src/components/VoiceFeedback/TimelineMarkerOverlay.tsx",
      "src/components/VoiceFeedback/AutoPauseNotification.tsx",
      "src/components/VoiceFeedback/UpcomingFeedbackPreview.tsx"
    ],
    "architecture": "Controller-Hook-Component composition pattern with event-driven video synchronization"
  }],
  "lastRead": null
}
